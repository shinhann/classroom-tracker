<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教室任務狀態追蹤器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
        }
        /* 自定義動畫 */
        @keyframes pop-in {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-in {
            animation: pop-in 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .btn-pulse:hover {
            animation: pulse 0.5s infinite;
        }
        .student-card {
            transition: all 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-yellow-50 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <!-- 主容器 -->
    <div id="app-container" class="w-full max-w-6xl mx-auto">

        <!-- 首頁/登入頁 -->
        <div id="home-view" class="text-center bg-white p-8 rounded-2xl shadow-lg">
            <h1 class="text-4xl font-extrabold text-blue-600 mb-2">🚀 教室任務衝衝衝！</h1>
            <p class="text-gray-500 mb-8">老師建立教室，學生加入冒險！</p>

            <div class="grid md:grid-cols-2 gap-8">
                <!-- 老師區塊 -->
                <div class="bg-blue-50 p-6 rounded-xl border-2 border-blue-200">
                    <h2 class="text-2xl font-bold text-blue-800 mb-4">👑 我是老師</h2>
                    <div class="flex flex-col space-y-4">
                        <input type="number" id="student-count" min="1" max="40" placeholder="班級有幾位學生？" class="p-3 border-2 border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none">
                        <button id="create-class-btn" class="w-full bg-blue-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:scale-105">建立教室</button>
                    </div>
                </div>

                <!-- 學生區塊 -->
                <div class="bg-green-50 p-6 rounded-xl border-2 border-green-200">
                    <h2 class="text-2xl font-bold text-green-800 mb-4">🎒 我是學生</h2>
                    <div class="flex flex-col space-y-4">
                        <input type="text" id="class-code-input" placeholder="教室代碼 (4位數字)" maxlength="4" class="p-3 border-2 border-green-200 rounded-lg focus:ring-2 focus:ring-green-400 focus:outline-none">
                        <select id="seat-number-select" class="p-3 border-2 border-green-200 rounded-lg bg-white focus:ring-2 focus:ring-green-400 focus:outline-none">
                            <option value="">請選擇座號</option>
                        </select>
                        <button id="join-class-btn" class="w-full bg-green-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-green-600 transition-all duration-300 transform hover:scale-105">加入教室</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 老師儀表板 -->
        <div id="teacher-view" class="hidden">
            <div class="flex flex-wrap justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-md gap-4">
                <div>
                    <h1 class="text-3xl font-extrabold text-indigo-700">教師儀表板</h1>
                    <p class="text-gray-600">教室代碼：<span id="teacher-class-code" class="font-bold text-2xl text-red-500 bg-yellow-100 px-2 py-1 rounded"></span></p>
                    <p class="text-gray-500 mt-1">分享此代碼給學生加入！</p>
                </div>
                <button id="end-class-btn" class="bg-red-500 text-white font-bold py-2 px-5 rounded-lg shadow-md hover:bg-red-600 transition-all duration-300">結束教室</button>
            </div>
            <div id="student-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
            </div>
        </div>

        <!-- 學生個人頁面 -->
        <div id="student-view" class="hidden text-center max-w-md mx-auto">
             <div class="bg-white p-8 rounded-3xl shadow-2xl">
                <p class="text-lg text-gray-500">教室代碼: <span id="student-class-code" class="font-bold text-blue-600"></span></p>
                <h1 class="text-5xl font-extrabold my-4">座號 <span id="student-seat-number" class="text-amber-500"></span></h1>
                <p class="text-2xl font-bold mb-6">我的任務狀態</p>
                <div id="status-display-container" class="p-6 rounded-2xl mb-6 transition-all duration-500">
                </div>
                <button id="change-status-btn" class="text-white font-bold py-4 px-8 rounded-2xl shadow-lg w-full transition-all duration-300 transform hover:scale-105 btn-pulse flex items-center justify-center space-x-4 text-2xl">
                </button>
            </div>
        </div>
    </div>
    
    <!-- 訊息 Modal -->
    <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl text-center max-w-sm mx-auto pop-in">
            <p id="modal-message" class="text-xl font-bold mb-6"></p>
            <button id="modal-close-btn" class="bg-blue-500 text-white font-bold py-2 px-8 rounded-lg hover:bg-blue-600 transition-all">好的</button>
        </div>
    </div>
    
    <!-- 確認 Modal -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl text-center max-w-sm mx-auto pop-in">
            <p id="confirmation-message" class="text-xl font-bold mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-btn" class="bg-red-500 text-white font-bold py-2 px-8 rounded-lg hover:bg-red-600 transition-all">確定</button>
                <button id="cancel-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-8 rounded-lg hover:bg-gray-400 transition-all">取消</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyC_M_5aXGEuFoDA58fHVbI-1Pv_YQK5x48",
          authDomain: "myclassroom-5bfe0.firebaseapp.com",
          projectId: "myclassroom-5bfe0",
          storageBucket: "myclassroom-5bfe0.firebasestorage.app",
          messagingSenderId: "869630526902",
          appId: "1:869630526902:web:7ccf8228a345b2a185ed17",
          measurementId: "G-05T2MNK9J4"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const STATUSES = {
            working: { text: "努力工作中...", color: "bg-blue-500", cardColor: "bg-blue-100 border-blue-400", icon: `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24"><path fill="currentColor" d="M14.5 9.5a1.5 1.5 0 1 1-3 0a1.5 1.5 0 0 1 3 0M9.5 9.5a1.5 1.5 0 1 1-3 0a1.5 1.5 0 0 1 3 0m.25 4.5a.75.75 0 0 0-1.5 0v1.5c0 .28.22.5.5.5h2.5a.75.75 0 0 0 0-1.5h-1.5zM12 2C6.477 2 2 6.477 2 12s4.477 10 10 10s10-4.477 10-10S17.523 2 12 2m0 2a8 8 0 1 1 0 16a8 8 0 0 1 0-16"/></svg>`},
            more_time: { text: "需要多一點時間", color: "bg-orange-500", cardColor: "bg-orange-100 border-orange-400", icon: `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24"><path fill="currentColor" d="M14.5 9.5a1.5 1.5 0 1 1-3 0a1.5 1.5 0 0 1 3 0M9.5 9.5a1.5 1.5 0 1 1-3 0a1.5 1.5 0 0 1 3 0m-2.25 4a.75.75 0 0 0-1.5 0v2.5c0 .13.05.25.15.35l1.75 1.75a.75.75 0 1 0 1.06-1.06l-1.41-1.41zM12 2C6.477 2 2 6.477 2 12s4.477 10 10 10s10-4.477 10-10S17.523 2 12 2m0 2a8 8 0 1 1 0 16a8 8 0 0 1 0-16"/></svg>`},
            help: { text: "需要老師協助！", color: "bg-red-500", cardColor: "bg-red-100 border-red-400", icon: `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24"><path fill="currentColor" d="M14.5 10.5a1.5 1.5 0 1 1-3 0a1.5 1.5 0 0 1 3 0m-5 0a1.5 1.5 0 1 1-3 0a1.5 1.5 0 0 1 3 0m2.25 4.25a.75.75 0 0 0-1.5 0v1a.75.75 0 0 0 1.5 0zM12 2C6.477 2 2 6.477 2 12s4.477 10 10 10s10-4.477 10-10S17.523 2 12 2m0 2a8 8 0 1 1 0 16a8 8 0 0 1 0-16"/></svg>`},
            completed: { text: "我完成了！耶！", color: "bg-green-500", cardColor: "bg-green-100 border-green-400", icon: `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24"><path fill="currentColor" d="M14.5 8.5a1.5 1.5 0 1 1-3 0a1.5 1.5 0 0 1 3 0m-5 0a1.5 1.5 0 1 1-3 0a1.5 1.5 0 0 1 3 0m-.293 6.707a1 1 0 0 0-1.414 0L6 17.025V15.5a1 1 0 0 0-2 0v2.5a1 1 0 0 0 1 1h2.5a1 1 0 0 0 0-2H6.414l1.793-1.793a1 1 0 0 0 0-1.414M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10s10-4.477 10-10S17.523 2 12 2m0 2a8 8 0 1 1 0 16a8 8 0 0 1 0-16"/></svg>`},
            offline: { text: "學生未上線", color: "bg-gray-400", cardColor: "bg-gray-200 border-gray-400", icon: `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10s10-4.477 10-10S17.523 2 12 2M6 10.5a1.5 1.5 0 1 1 3 0a1.5 1.5 0 0 1-3 0m7.5 0a1.5 1.5 0 1 1 3 0a1.5 1.5 0 0 1-3 0m-3.515 4.235a.75.75 0 0 0-1.06-1.06l-2.25 2.25a.75.75 0 1 0 1.06 1.06zM12 18a4 4 0 0 0 3.164-1.535l-5.63-5.63A4 4 0 0 0 12 18"/></svg>`}
        };
        const statusOrder = ['working', 'more_time', 'help', 'completed'];
        let currentStatusUnsubscribe = null;
        let userId = null;
        let authReady = false;

        // --- 核心啟動邏輯 ---
        function main() {
            document.getElementById('create-class-btn').onclick = createClassroom;
            document.getElementById('join-class-btn').onclick = joinClassroom;
            populateSeatSelector();
            
            window.addEventListener('hashchange', routeApp);

            const unsubscribe = onAuthStateChanged(auth, (user) => {
                if (user) {
                    unsubscribe(); 
                    authReady = true;
                    userId = user.uid;
                    console.log("Firebase 驗證成功，ID:", userId, "正在路由...");
                    routeApp();
                }
            });
            authenticateUser();
        }

        async function authenticateUser() {
            if (auth.currentUser) {
                 if (!authReady) {
                    authReady = true;
                    userId = auth.currentUser.uid;
                    routeApp();
                }
                return;
            }
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("匿名登入失敗。", error);
                showMessage("驗證失敗，請刷新頁面再試。");
            }
        }

        function routeApp() {
            const hash = window.location.hash.slice(1);
            const parts = hash.split('/').filter(p => p); 
            const view = parts[0];
            const code = parts[1];
            const seat = parts[2];

            if (view === 'teacher' && code) {
                showTeacherView(code);
            } else if (view === 'student' && code && seat) {
                showStudentView(code, seat);
            } else {
                showHomeView();
            }
        }

        function populateSeatSelector() {
            const seatSelect = document.getElementById('seat-number-select');
            if (seatSelect.options.length <= 1) {
                 for (let i = 1; i <= 40; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i}號`;
                    seatSelect.appendChild(option);
                }
            }
        }
        
        function showView(viewId) {
            ['home-view', 'teacher-view', 'student-view'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');
        }

        function showHomeView() {
            showView('home-view');
        }

        function showTeacherView(classCode) {
            showView('teacher-view');
            document.getElementById('teacher-class-code').textContent = classCode;
            document.getElementById('end-class-btn').onclick = () => endClassroom(classCode);
            const classroomRef = doc(db, `artifacts/${firebaseConfig.projectId}/public/data/classrooms`, classCode);
            if (currentStatusUnsubscribe) currentStatusUnsubscribe();
            currentStatusUnsubscribe = onSnapshot(classroomRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (!data.isActive) {
                        if (currentStatusUnsubscribe) currentStatusUnsubscribe();
                        showMessage("這個教室已被老師關閉。", () => {
                           window.location.hash = '';
                        });
                        return;
                    }
                    renderStudentGrid(data.studentCount, data.students || {});
                } else {
                    if (currentStatusUnsubscribe) currentStatusUnsubscribe();
                    showMessage("找不到這個教室！", () => {
                        window.location.hash = '';
                    });
                }
            });
        }
        
        async function showStudentView(classCode, seat) {
            showView('student-view');
            document.getElementById('student-class-code').textContent = classCode;
            document.getElementById('student-seat-number').textContent = seat;
            const classroomRef = doc(db, `artifacts/${firebaseConfig.projectId}/public/data/classrooms`, classCode);
            try {
                const docSnap = await getDoc(classroomRef);
                if (!docSnap.exists() || !docSnap.data().isActive) {
                    showMessage("教室不存在或已關閉。", () => {
                        window.location.hash = '';
                     });
                    return;
                }
                await updateStudentStatus(classCode, seat, 'working', true);
                document.getElementById('change-status-btn').onclick = () => changeStatus(classCode, seat);
                if (currentStatusUnsubscribe) currentStatusUnsubscribe();
                currentStatusUnsubscribe = onSnapshot(classroomRef, (docSnap) => {
                    if (!docSnap.exists() || !docSnap.data().isActive) {
                        if (currentStatusUnsubscribe) currentStatusUnsubscribe();
                        showMessage("老師已結束教室。", () => {
                           window.location.hash = '';
                        });
                        return;
                    }
                    const students = docSnap.data().students || {};
                    const myStatus = students[seat]?.status || 'working';
                    updateStudentUI(myStatus);
                });
                window.addEventListener('beforeunload', () => {
                    updateStudentStatus(classCode, seat, 'offline', false);
                });
            } catch (error) {
                console.error("進入學生頁面時發生錯誤:", error);
                showMessage("加入教室時發生錯誤。");
            }
        }

        async function createClassroom() {
            if (!authReady) {
                showMessage("系統正在初始化，請稍候片刻再試一次。");
                return;
            }
            const studentCount = parseInt(document.getElementById('student-count').value);
            if (!studentCount || studentCount < 1 || studentCount > 40) {
                showMessage("請輸入有效的學生人數 (1-40)。");
                return;
            }
            let classCode;
            let classExists = true;
            while(classExists) {
                classCode = Math.floor(1000 + Math.random() * 9000).toString();
                const classroomRef = doc(db, `artifacts/${firebaseConfig.projectId}/public/data/classrooms`, classCode);
                const docSnap = await getDoc(classroomRef);
                classExists = docSnap.exists();
            }
            const initialStudents = {};
            for(let i=1; i<=studentCount; i++) {
                initialStudents[i] = { status: 'offline', online: false };
            }
            const classroomData = {
                teacherId: userId,
                studentCount: studentCount,
                students: initialStudents,
                createdAt: serverTimestamp(),
                isActive: true
            };
            try {
                await setDoc(doc(db, `artifacts/${firebaseConfig.projectId}/public/data/classrooms`, classCode), classroomData);
                window.location.hash = `#/teacher/${classCode}`;
            } catch (error) {
                console.error("建立教室時發生錯誤: ", error);
                showMessage("建立教室時發生錯誤，請稍後再試。");
            }
        }
        
        function endClassroom(classCode) {
            showConfirmation("您確定要結束這個教室嗎？", async () => {
                const classroomRef = doc(db, `artifacts/${firebaseConfig.projectId}/public/data/classrooms`, classCode);
                try {
                    await updateDoc(classroomRef, { isActive: false });
                } catch(error) {
                    console.error("結束教室時發生錯誤: ", error);
                    showMessage("關閉教室時發生錯誤。");
                }
            });
        }

        function renderStudentGrid(studentCount, students) {
            const grid = document.getElementById('student-grid');
            grid.innerHTML = '';
            for (let i = 1; i <= studentCount; i++) {
                const studentData = students[i] || { status: 'offline', online: false };
                const statusKey = studentData.online ? studentData.status : 'offline';
                const statusInfo = STATUSES[statusKey] || STATUSES['offline'];
                const card = document.createElement('div');
                card.className = `student-card p-4 rounded-xl border-4 shadow-md text-center flex flex-col items-center justify-center pop-in ${statusInfo.cardColor}`;
                card.style.animationDelay = `${i * 30}ms`;
                card.innerHTML = `
                    <div class="text-4xl font-extrabold">${i}</div>
                    <div class="my-2 w-16 h-16 flex items-center justify-center">${statusInfo.icon}</div>
                    <div class="font-bold text-sm h-10 flex items-center justify-center text-center">${statusInfo.text}</div>
                `;
                grid.appendChild(card);
            }
        }

        async function joinClassroom() {
            if (!authReady) {
                showMessage("系統正在初始化，請稍候片刻再試一次。");
                return;
            }
            const classCode = document.getElementById('class-code-input').value;
            const seatNumber = document.getElementById('seat-number-select').value;
            if (!classCode || !seatNumber) {
                showMessage("請輸入教室代碼並選擇座號！");
                return;
            }
            const classroomRef = doc(db, `artifacts/${firebaseConfig.projectId}/public/data/classrooms`, classCode);
            try {
                const docSnap = await getDoc(classroomRef);
                if (docSnap.exists() && docSnap.data().isActive) {
                    const studentCount = docSnap.data().studentCount;
                    if (parseInt(seatNumber) > studentCount) {
                        showMessage("這個座號不存在於此教室！");
                        return;
                    }
                    window.location.hash = `#/student/${classCode}/${seatNumber}`;
                } else {
                    showMessage("找不到這個教室，或教室已經關閉。");
                }
            } catch (error) {
                console.error("加入教室時發生錯誤: ", error);
                showMessage("加入教室時發生錯誤。");
            }
        }

        async function changeStatus(classCode, seat) {
            const classroomRef = doc(db, `artifacts/${firebaseConfig.projectId}/public/data/classrooms`, classCode);
            try {
                const docSnap = await getDoc(classroomRef);
                if (docSnap.exists()) {
                    const currentStatus = docSnap.data().students[seat].status;
                    const currentIndex = statusOrder.indexOf(currentStatus);
                    const nextIndex = (currentIndex + 1) % statusOrder.length;
                    const nextStatus = statusOrder[nextIndex];
                    await updateStudentStatus(classCode, seat, nextStatus, true);
                }
            } catch (e) {
                console.error("更改狀態失敗", e)
            }
        }
        
        async function updateStudentStatus(classCode, seat, status, isOnline) {
             const classroomRef = doc(db, `artifacts/${firebaseConfig.projectId}/public/data/classrooms`, classCode);
             const updateData = {};
             updateData[`students.${seat}.status`] = status;
             updateData[`students.${seat}.online`] = isOnline;
             try {
                await updateDoc(classroomRef, updateData);
             } catch(error) {
                console.error("更新狀態時發生錯誤:", error);
                if (isOnline) { 
                    showMessage("更新狀態失敗，請檢查網路連線。");
                }
             }
        }

        function updateStudentUI(status) {
            const statusInfo = STATUSES[status] || STATUSES['working'];
            const displayContainer = document.getElementById('status-display-container');
            const changeBtn = document.getElementById('change-status-btn');
            displayContainer.className = `p-8 rounded-2xl mb-6 transition-all duration-500 ${statusInfo.cardColor}`;
            displayContainer.innerHTML = `<div class="w-32 h-32 mx-auto flex items-center justify-center">${statusInfo.icon}</div>`;
            changeBtn.className = `text-white font-bold py-4 px-8 rounded-2xl shadow-lg w-full transition-all duration-300 transform hover:scale-105 btn-pulse flex items-center justify-center space-x-4 text-2xl ${statusInfo.color}`;
            changeBtn.innerHTML = `
                <span>${statusInfo.text}</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                <span class="opacity-75 text-lg">(點我切換)</span>
            `;
        }
        
        function showMessage(message, onclose) {
            const modal = document.getElementById('message-modal');
            const messageP = document.getElementById('modal-message');
            const closeBtn = document.getElementById('modal-close-btn');
            messageP.textContent = message;
            modal.classList.remove('hidden');
            closeBtn.onclick = () => {
                modal.classList.add('hidden');
                if (onclose) {
                    onclose();
                }
            };
        }
        
        function showConfirmation(message, onConfirm) {
            const modal = document.getElementById('confirmation-modal');
            const messageP = document.getElementById('confirmation-message');
            const confirmBtn = document.getElementById('confirm-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            messageP.textContent = message;
            modal.classList.remove('hidden');
            confirmBtn.onclick = () => {
                modal.classList.add('hidden');
                if (onConfirm) {
                    onConfirm();
                }
            };
            cancelBtn.onclick = () => {
                modal.classList.add('hidden');
            };
        }

        main();
    </script>
</body>
</html>
