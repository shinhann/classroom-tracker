<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å®¤ä»»å‹™ç‹€æ…‹è¿½è¹¤å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
        }
        @keyframes pop-in {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-in {
            animation: pop-in 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
        }
        .student-card {
            transition: all 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-yellow-50 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <!-- ä¸»å®¹å™¨ -->
    <div id="app-container" class="w-full max-w-6xl mx-auto">

        <!-- åˆå§‹è¼‰å…¥/èº«ä»½é¸æ“‡ç•«é¢ -->
        <div id="role-selection-view" class="max-w-xl mx-auto">
            <div class="text-center bg-white p-8 rounded-2xl shadow-lg">
                <h1 class="text-4xl font-extrabold text-indigo-700 mb-2">ğŸš€ æ•™å®¤ä»»å‹™è¡è¡è¡ï¼</h1>
                <p class="text-gray-500 mb-8">è«‹é¸æ“‡æ‚¨çš„èº«ä»½</p>
                <div class="space-y-4">
                    <button id="teacher-role-btn" class="w-full bg-blue-500 text-white font-bold py-4 px-6 rounded-lg shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:scale-105 text-2xl">ğŸ‘‘ æˆ‘æ˜¯è€å¸«</button>
                    <button id="student-role-btn" class="w-full bg-green-500 text-white font-bold py-4 px-6 rounded-lg shadow-md hover:bg-green-600 transition-all duration-300 transform hover:scale-105 text-2xl">ğŸ’ æˆ‘æ˜¯å­¸ç”Ÿ</button>
                </div>
            </div>
        </div>
        
        <!-- è€å¸«ç™»å…¥/å»ºç«‹æ•™å®¤ç•«é¢ -->
        <div id="teacher-main-view" class="hidden max-w-xl mx-auto text-center">
             <div class="bg-white p-8 rounded-2xl shadow-lg">
                <div id="teacher-login-panel">
                    <h2 class="text-2xl font-bold text-blue-800 mb-4">è€å¸«ï¼Œè«‹ç™»å…¥ä»¥ç¹¼çºŒ</h2>
                    <button id="google-login-btn" class="w-full bg-white border-2 border-gray-300 text-gray-700 font-bold py-3 px-6 rounded-lg shadow-sm hover:bg-gray-50 flex items-center justify-center space-x-2">
                        <svg class="w-6 h-6" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                        <span>ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</span>
                    </button>
                </div>
                 <div id="create-class-panel" class="hidden">
                     <h2 class="text-2xl font-bold text-blue-800 mb-4">æ­¡è¿ï¼Œ<span id="teacher-name"></span>è€å¸«ï¼</h2>
                     <p class="text-gray-500 mb-6">è«‹è¼¸å…¥å­¸ç”Ÿäººæ•¸ä»¥å»ºç«‹æ–°æ•™å®¤ã€‚</p>
                     <input type="number" id="student-count" min="1" max="40" placeholder="ç­ç´šæœ‰å¹¾ä½å­¸ç”Ÿï¼Ÿ" class="w-full p-3 border-2 border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none mb-4">
                     <button id="create-class-btn" class="w-full bg-blue-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-600">å»ºç«‹æ•™å®¤</button>
                 </div>
            </div>
        </div>

        <!-- å­¸ç”Ÿç™»å…¥ç•«é¢ -->
        <div id="student-join-view" class="hidden max-w-xl mx-auto">
             <div class="mt-4 bg-white p-8 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold text-green-800 mb-4">åŠ å…¥æ•™å®¤</h2>
                <div class="flex flex-col space-y-4">
                    <input type="text" id="class-code-input" placeholder="æ•™å®¤ä»£ç¢¼ (4ä½æ•¸å­—)" maxlength="4" class="p-3 border-2 border-green-200 rounded-lg focus:ring-2 focus:ring-green-400 focus:outline-none">
                    <select id="seat-number-select" class="p-3 border-2 border-green-200 rounded-lg bg-white focus:ring-2 focus:ring-green-400 focus:outline-none">
                        <option value="">è«‹é¸æ“‡åº§è™Ÿ</option>
                    </select>
                    <button id="join-class-btn" class="w-full bg-green-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-green-600">åŠ å…¥æ•™å®¤</button>
                </div>
            </div>
        </div>

        <!-- è€å¸«å„€è¡¨æ¿ -->
        <div id="teacher-dashboard-view" class="hidden">
            <div class="flex flex-wrap justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-md gap-4">
                <div>
                    <h1 class="text-3xl font-extrabold text-indigo-700">æ•™å¸«å„€è¡¨æ¿</h1>
                    <p class="text-gray-600">æ•™å®¤ä»£ç¢¼ï¼š<span id="teacher-class-code" class="font-bold text-2xl text-red-500 bg-yellow-100 px-2 py-1 rounded"></span></p>
                </div>
                <button id="end-class-btn" class="bg-red-500 text-white font-bold py-2 px-5 rounded-lg shadow-md hover:bg-red-600">çµæŸæ•™å®¤</button>
            </div>
            <div id="student-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4"></div>
        </div>

        <!-- å­¸ç”Ÿå€‹äººé é¢ -->
        <div id="student-task-view" class="hidden"></div>
    </div>
    
    <!-- Modals (no change) -->
    <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl text-center max-w-sm mx-auto pop-in">
            <p id="modal-message" class="text-xl font-bold mb-6"></p>
            <button id="modal-close-btn" class="bg-blue-500 text-white font-bold py-2 px-8 rounded-lg hover:bg-blue-600">å¥½çš„</button>
        </div>
    </div>
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl text-center max-w-sm mx-auto pop-in">
            <p id="confirmation-message" class="text-xl font-bold mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-btn" class="bg-red-500 text-white font-bold py-2 px-8 rounded-lg hover:bg-red-600">ç¢ºå®š</button>
                <button id="cancel-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-8 rounded-lg hover:bg-gray-400">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyC_M_5aXGEuFoDA58fHVbI-1Pv_YQK5x48",
          authDomain: "myclassroom-5bfe0.firebaseapp.com",
          projectId: "myclassroom-5bfe0",
          storageBucket: "myclassroom-5bfe0.firebasestorage.app",
          messagingSenderId: "869630526902",
          appId: "1:869630526902:web:7ccf8228a345b2a185ed17",
          measurementId: "G-05T2MNK9J4"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const STATUSES = {
            working: { text: "åŠªåŠ›å·¥ä½œä¸­...", color: "bg-blue-500", cardColor: "bg-blue-100 border-blue-400", icon: `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24"><path fill="currentColor" d="M14.5 9.5a1.5 1.5 0 1 1-3 0a1.5 1.5 0 0 1 3 0M9.5 9.5a1.5 1.5 0 1 1-3 0a1.5 1.5 0 0 1 3 0m.25 4.5a.75.75 0 0 0-1.5 0v1.5c0 .28.22.5.5.5h2.5a.75.75 0 0 0 0-1.5h-1.5zM12 2C6.477 2 2 6.477 2 12s4.477 10 10 10s10-4.477 10-10S17.523 2 12 2m0 2a8 8 0 1 1 0 16a8 8 0 0 1 0-16"/></svg>`},
            more_time: { text: "éœ€è¦å¤šä¸€é»æ™‚é–“", color: "bg-orange-500", cardColor: "bg-orange-100 border-orange-400", icon: `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24"><path fill="currentColor" d="M14.5 9.5a1.5 1.5 0 1 1-3 0a1.5 1.5 0 0 1 3 0M9.5 9.5a1.5 1.5 0 1 1-3 0a1.5 1.5 0 0 1 3 0m-2.25 4a.75.75 0 0 0-1.5 0v2.5c0 .13.05.25.15.35l1.75 1.75a.75.75 0 1 0 1.06-1.06l-1.41-1.41zM12 2C6.477 2 2 6.477 2 12s4.477 10 10 10s10-4.477 10-10S17.523 2 12 2m0 2a8 8 0 1 1 0 16a8 8 0 0 1 0-16"/></svg>`},
            help: { text: "éœ€è¦è€å¸«å”åŠ©ï¼", color: "bg-red-500", cardColor: "bg-red-100 border-red-400", icon: `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24"><path fill="currentColor" d="M14.5 10.5a1.5 1.5 0 1 1-3 0a1.5 1.5 0 0 1 3 0m-5 0a1.5 1.5 0 1 1-3 0a1.5 1.5 0 0 1 3 0m2.25 4.25a.75.75 0 0 0-1.5 0v1a.75.75 0 0 0 1.5 0zM12 2C6.477 2 2 6.477 2 12s4.477 10 10 10s10-4.477 10-10S17.523 2 12 2m0 2a8 8 0 1 1 0 16a8 8 0 0 1 0-16"/></svg>`},
            completed: { text: "æˆ‘å®Œæˆäº†ï¼è€¶ï¼", color: "bg-green-500", cardColor: "bg-green-100 border-green-400", icon: `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24"><path fill="currentColor" d="M14.5 8.5a1.5 1.5 0 1 1-3 0a1.5 1.5 0 0 1 3 0m-5 0a1.5 1.5 0 1 1-3 0a1.5 1.5 0 0 1 3 0m-.293 6.707a1 1 0 0 0-1.414 0L6 17.025V15.5a1 1 0 0 0-2 0v2.5a1 1 0 0 0 1 1h2.5a1 1 0 0 0 0-2H6.414l1.793-1.793a1 1 0 0 0 0-1.414M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10s10-4.477 10-10S17.523 2 12 2m0 2a8 8 0 1 1 0 16a8 8 0 0 1 0-16"/></svg>`},
            offline: { text: "å­¸ç”Ÿæœªä¸Šç·š", color: "bg-gray-400", cardColor: "bg-gray-200 border-gray-400", icon: `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10s10-4.477 10-10S17.523 2 12 2M6 10.5a1.5 1.5 0 1 1 3 0a1.5 1.5 0 0 1-3 0m7.5 0a1.5 1.5 0 1 1 3 0a1.5 1.5 0 0 1-3 0m-3.515 4.235a.75.75 0 0 0-1.06-1.06l-2.25 2.25a.75.75 0 1 0 1.06 1.06zM12 18a4 4 0 0 0 3.164-1.535l-5.63-5.63A4 4 0 0 0 12 18"/></svg>`}
        };
        const statusOrder = ['working', 'more_time', 'help', 'completed'];
        let currentStatusUnsubscribe = null;
        let userId = null;

        // --- æ ¸å¿ƒå•Ÿå‹•é‚è¼¯ ---
        function main() {
            document.getElementById('teacher-role-btn').onclick = showTeacherPanel;
            document.getElementById('student-role-btn').onclick = showStudentPanel;
            document.getElementById('google-login-btn').onclick = signInAsTeacher;
            document.getElementById('create-class-btn').onclick = createClassroom;
            document.getElementById('join-class-btn').onclick = joinClassroom;
            
            populateSeatSelector();
            window.addEventListener('hashchange', routeApp);
            
            onAuthStateChanged(auth, (user) => {
                if(user && !user.isAnonymous) {
                    console.log("åµæ¸¬åˆ°è€å¸«ç™»å…¥:", user.displayName);
                    userId = user.uid;
                    updateUIToTeacherLoggedIn(user);
                } else {
                    console.log("ç”¨æˆ¶ç‚ºåŒ¿åæˆ–å·²ç™»å‡ºã€‚");
                    updateUIToLoggedOut();
                }
                routeApp();
            });
        }
        
        function showView(viewId) {
            ['role-selection-view', 'teacher-main-view', 'student-join-view', 'teacher-dashboard-view', 'student-task-view'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');
        }

        function routeApp() {
            const hash = window.location.hash.slice(1);
            const parts = hash.split('/').filter(p => p); 
            const view = parts[0];
            const code = parts[1];
            const seat = parts[2];

            if (view === 'teacher' && code) {
                showTeacherDashboard(code);
            } else if (view === 'student' && code && seat) {
                showStudentTaskPage(code, seat);
            } else {
                // Not in a specific classroom view, decide based on login state
                if (auth.currentUser && !auth.currentUser.isAnonymous) {
                    showView('teacher-main-view');
                } else {
                    showView('role-selection-view');
                }
            }
        }
        
        function showTeacherPanel() {
            showView('teacher-main-view');
        }

        function showStudentPanel() {
            showView('student-join-view');
        }

        function updateUIToTeacherLoggedIn(user) {
            showView('teacher-main-view');
            document.getElementById('teacher-login-panel').classList.add('hidden');
            const createPanel = document.getElementById('create-class-panel');
            createPanel.classList.remove('hidden');
            document.getElementById('teacher-name').textContent = user.displayName || 'è€å¸«';
        }
        
        function updateUIToLoggedOut() {
            showView('role-selection-view');
            document.getElementById('teacher-login-panel').classList.remove('hidden');
            document.getElementById('create-class-panel').classList.add('hidden');
        }

        async function signInAsTeacher() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                // onAuthStateChanged will handle the UI update
            } catch (error) {
                console.error("Google ç™»å…¥å¤±æ•—:", error);
                showMessage("ä½¿ç”¨ Google ç™»å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            }
        }

        async function joinClassroom() {
            try {
                // Ensure student is anonymously signed in
                if (!auth.currentUser || !auth.currentUser.isAnonymous) {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser.uid;
                
                const classCode = document.getElementById('class-code-input').value;
                const seatNumber = document.getElementById('seat-number-select').value;
                if (!classCode || !seatNumber) {
                    return showMessage("è«‹è¼¸å…¥æ•™å®¤ä»£ç¢¼ä¸¦é¸æ“‡åº§è™Ÿï¼");
                }

                const classroomRef = doc(db, `artifacts/${firebaseConfig.projectId}/public/data/classrooms`, classCode);
                const docSnap = await getDoc(classroomRef);
                if (docSnap.exists() && docSnap.data().isActive) {
                    const studentCount = docSnap.data().studentCount;
                    if (parseInt(seatNumber) > studentCount) {
                        return showMessage("é€™å€‹åº§è™Ÿä¸å­˜åœ¨æ–¼æ­¤æ•™å®¤ï¼");
                    }
                    window.location.hash = `#/student/${classCode}/${seatNumber}`;
                } else {
                    showMessage("æ‰¾ä¸åˆ°é€™å€‹æ•™å®¤ï¼Œæˆ–æ•™å®¤å·²ç¶“é—œé–‰ã€‚");
                }
            } catch (error) {
                 console.error("åŠ å…¥æ•™å®¤å¤±æ•—:", error);
                 showMessage("åŠ å…¥æ•™å®¤æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚");
            }
        }
        
        // ---- The rest of the functions (createClassroom, showTeacherDashboard, etc.) are largely the same ----
        // ---- with minor tweaks to view IDs and data paths ----

        function populateSeatSelector() {
            const seatSelect = document.getElementById('seat-number-select');
            if (seatSelect.options.length <= 1) {
                 for (let i = 1; i <= 40; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i}è™Ÿ`;
                    seatSelect.appendChild(option);
                }
            }
        }

        function showTeacherDashboard(classCode) {
            showView('teacher-dashboard-view');
            document.getElementById('teacher-class-code').textContent = classCode;
            document.getElementById('end-class-btn').onclick = () => endClassroom(classCode);
            const classroomRef = doc(db, `artifacts/${firebaseConfig.projectId}/public/data/classrooms`, classCode);
            if (currentStatusUnsubscribe) currentStatusUnsubscribe();
            currentStatusUnsubscribe = onSnapshot(classroomRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (!data.isActive) {
                        if (currentStatusUnsubscribe) currentStatusUnsubscribe();
                        showMessage("é€™å€‹æ•™å®¤å·²è¢«è€å¸«é—œé–‰ã€‚", () => { window.location.hash = ''; });
                        return;
                    }
                    renderStudentGrid(data.studentCount, data.students || {});
                } else {
                    if (currentStatusUnsubscribe) currentStatusUnsubscribe();
                    showMessage("æ‰¾ä¸åˆ°é€™å€‹æ•™å®¤ï¼", () => { window.location.hash = ''; });
                }
            });
        }
        
        async function showStudentTaskPage(classCode, seat) {
            showView('student-task-view');
            // Inject the student UI into the container
            document.getElementById('student-task-view').innerHTML = `
             <div class="bg-white p-8 rounded-3xl shadow-2xl">
                <p class="text-lg text-gray-500">æ•™å®¤ä»£ç¢¼: <span id="student-class-code-task" class="font-bold text-blue-600"></span></p>
                <h1 class="text-5xl font-extrabold my-4">åº§è™Ÿ <span id="student-seat-number-task" class="text-amber-500"></span></h1>
                <p class="text-2xl font-bold mb-6">æˆ‘çš„ä»»å‹™ç‹€æ…‹</p>
                <div id="status-display-container" class="p-6 rounded-2xl mb-6 transition-all duration-500"></div>
                <button id="change-status-btn" class="text-white font-bold py-4 px-8 rounded-2xl shadow-lg w-full transition-all duration-300 flex items-center justify-center space-x-4 text-2xl"></button>
            </div>`;
            
            document.getElementById('student-class-code-task').textContent = classCode;
            document.getElementById('student-seat-number-task').textContent = seat;

            const classroomRef = doc(db, `artifacts/${firebaseConfig.projectId}/public/data/classrooms`, classCode);
            try {
                // Ensure student is anonymously signed in
                if (!auth.currentUser || !auth.currentUser.isAnonymous) {
                   await signInAnonymously(auth);
                }
                
                const docSnap = await getDoc(classroomRef);
                if (!docSnap.exists() || !docSnap.data().isActive) {
                    return showMessage("æ•™å®¤ä¸å­˜åœ¨æˆ–å·²é—œé–‰ã€‚", () => { window.location.hash = ''; });
                }
                await updateStudentStatus(classCode, seat, 'working', true);
                document.getElementById('change-status-btn').onclick = () => changeStatus(classCode, seat);
                if (currentStatusUnsubscribe) currentStatusUnsubscribe();
                currentStatusUnsubscribe = onSnapshot(classroomRef, (docSnap) => {
                    if (!docSnap.exists() || !docSnap.data().isActive) {
                        if (currentStatusUnsubscribe) currentStatusUnsubscribe();
                        return showMessage("è€å¸«å·²çµæŸæ•™å®¤ã€‚", () => { window.location.hash = ''; });
                    }
                    const students = docSnap.data().students || {};
                    const myStatus = students[seat]?.status || 'working';
                    updateStudentUI(myStatus);
                });
                window.addEventListener('beforeunload', () => {
                    updateStudentStatus(classCode, seat, 'offline', false);
                });
            } catch (error) {
                console.error("é€²å…¥å­¸ç”Ÿé é¢æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                showMessage("åŠ å…¥æ•™å®¤æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚");
            }
        }

        async function createClassroom() {
            if (!auth.currentUser || auth.currentUser.isAnonymous) {
                return showMessage("è«‹å…ˆç™»å…¥è€å¸«å¸³è™Ÿã€‚");
            }
            const studentCount = parseInt(document.getElementById('student-count').value);
            if (!studentCount || studentCount < 1 || studentCount > 40) {
                return showMessage("è«‹è¼¸å…¥æœ‰æ•ˆçš„å­¸ç”Ÿäººæ•¸ (1-40)ã€‚");
            }
            let classCode;
            let classExists = true;
            while(classExists) {
                classCode = Math.floor(1000 + Math.random() * 9000).toString();
                const classroomRef = doc(db, `artifacts/${firebaseConfig.projectId}/public/data/classrooms`, classCode);
                const docSnap = await getDoc(classroomRef);
                classExists = docSnap.exists();
            }
            const initialStudents = {};
            for(let i=1; i<=studentCount; i++) {
                initialStudents[i] = { status: 'offline', online: false };
            }
            const classroomData = {
                teacherId: auth.currentUser.uid,
                studentCount: studentCount,
                students: initialStudents,
                createdAt: serverTimestamp(),
                isActive: true
            };
            try {
                await setDoc(doc(db, `artifacts/${firebaseConfig.projectId}/public/data/classrooms`, classCode), classroomData);
                window.location.hash = `#/teacher/${classCode}`;
            } catch (error) {
                console.error("å»ºç«‹æ•™å®¤æ™‚ç™¼ç”ŸéŒ¯èª¤: ", error);
                showMessage("å»ºç«‹æ•™å®¤æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            }
        }
        
        function endClassroom(classCode) {
            showConfirmation("æ‚¨ç¢ºå®šè¦çµæŸé€™å€‹æ•™å®¤å—ï¼Ÿ", async () => {
                const classroomRef = doc(db, `artifacts/${firebaseConfig.projectId}/public/data/classrooms`, classCode);
                try {
                    await updateDoc(classroomRef, { isActive: false });
                } catch(error) {
                    console.error("çµæŸæ•™å®¤æ™‚ç™¼ç”ŸéŒ¯èª¤: ", error);
                    showMessage("é—œé–‰æ•™å®¤æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚");
                }
            });
        }

        function renderStudentGrid(studentCount, students) {
            const grid = document.getElementById('student-grid');
            grid.innerHTML = '';
            for (let i = 1; i <= studentCount; i++) {
                const studentData = students[i] || { status: 'offline', online: false };
                const statusKey = studentData.online ? studentData.status : 'offline';
                const statusInfo = STATUSES[statusKey] || STATUSES['offline'];
                const card = document.createElement('div');
                card.className = `student-card p-4 rounded-xl border-4 shadow-md text-center flex flex-col items-center justify-center pop-in ${statusInfo.cardColor}`;
                card.style.animationDelay = `${i * 30}ms`;
                card.innerHTML = `
                    <div class="text-4xl font-extrabold">${i}</div>
                    <div class="my-2 w-16 h-16 flex items-center justify-center">${statusInfo.icon}</div>
                    <div class="font-bold text-sm h-10 flex items-center justify-center text-center">${statusInfo.text}</div>
                `;
                grid.appendChild(card);
            }
        }

        async function changeStatus(classCode, seat) {
            const classroomRef = doc(db, `artifacts/${firebaseConfig.projectId}/public/data/classrooms`, classCode);
            try {
                const docSnap = await getDoc(classroomRef);
                if (docSnap.exists()) {
                    const currentStatus = docSnap.data().students[seat].status;
                    const currentIndex = statusOrder.indexOf(currentStatus);
                    const nextIndex = (currentIndex + 1) % statusOrder.length;
                    const nextStatus = statusOrder[nextIndex];
                    await updateStudentStatus(classCode, seat, nextStatus, true);
                }
            } catch (e) { console.error("æ›´æ”¹ç‹€æ…‹å¤±æ•—", e) }
        }
        
        async function updateStudentStatus(classCode, seat, status, isOnline) {
             const classroomRef = doc(db, `artifacts/${firebaseConfig.projectId}/public/data/classrooms`, classCode);
             const updateData = {};
             updateData[`students.${seat}.status`] = status;
             updateData[`students.${seat}.online`] = isOnline;
             try {
                await updateDoc(classroomRef, updateData);
             } catch(error) {
                console.error("æ›´æ–°ç‹€æ…‹æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                if (isOnline) { showMessage("æ›´æ–°ç‹€æ…‹å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚"); }
             }
        }

        function updateStudentUI(status) {
            const statusInfo = STATUSES[status] || STATUSES['working'];
            const displayContainer = document.getElementById('status-display-container');
            const changeBtn = document.getElementById('change-status-btn');
            displayContainer.className = `p-8 rounded-2xl mb-6 transition-all duration-500 ${statusInfo.cardColor}`;
            displayContainer.innerHTML = `<div class="w-32 h-32 mx-auto flex items-center justify-center">${statusInfo.icon}</div>`;
            changeBtn.className = `text-white font-bold py-4 px-8 rounded-2xl shadow-lg w-full transition-all duration-300 flex items-center justify-center space-x-4 text-2xl ${statusInfo.color}`;
            changeBtn.innerHTML = `
                <span>${statusInfo.text}</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                <span class="opacity-75 text-lg">(é»æˆ‘åˆ‡æ›)</span>
            `;
        }
        
        function showMessage(message, onclose) {
            const modal = document.getElementById('message-modal');
            const messageP = document.getElementById('modal-message');
            const closeBtn = document.getElementById('modal-close-btn');
            messageP.textContent = message;
            modal.classList.remove('hidden');
            closeBtn.onclick = () => {
                modal.classList.add('hidden');
                if (onclose) { onclose(); }
            };
        }
        
        function showConfirmation(message, onConfirm) {
            const modal = document.getElementById('confirmation-modal');
            const messageP = document.getElementById('confirmation-message');
            const confirmBtn = document.getElementById('confirm-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            messageP.textContent = message;
            modal.classList.remove('hidden');
            confirmBtn.onclick = () => {
                modal.classList.add('hidden');
                if (onConfirm) { onConfirm(); }
            };
            cancelBtn.onclick = () => { modal.classList.add('hidden'); };
        }

        main();
    </script>
</body>
</html>
